name: ğŸš€ Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

env:
  GO_VERSION: '1.23'
  NODE_VERSION: '18'

jobs:
  build-and-release:
    name: ğŸ—ï¸ Build and Release
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Go ç¯å¢ƒ
      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 4. è®¾ç½® pnpm
      - name: ğŸ“¦ Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      # 5. ç¼“å­˜ Go æ¨¡å—
      - name: ğŸ’¾ Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # 6. ç¼“å­˜ Node.js ä¾èµ–
      - name: ğŸ’¾ Cache Node.js dependencies
        uses: actions/cache@v4
        with:
          path: |
            web/node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('web/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 7. å®‰è£…å‰ç«¯ä¾èµ–
      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./web
        run: pnpm install --frozen-lockfile

      # 8. æ„å»ºå‰ç«¯é¡¹ç›®
      - name: ğŸ—ï¸ Build frontend
        working-directory: ./web
        run: pnpm build

      # 9. éªŒè¯å‰ç«¯æ„å»ºäº§ç‰©
      - name: âœ… Verify frontend build
        run: |
          if [ ! -d "web/dist" ]; then
            echo "âŒ Frontend build failed: web/dist directory not found"
            exit 1
          fi
          if [ ! -f "web/dist/index.html" ]; then
            echo "âŒ Frontend build failed: index.html not found"
            exit 1
          fi
          echo "âœ… Frontend build successful"
          ls -la web/dist/

      # 10. ä¸‹è½½ Go ä¾èµ–
      - name: ğŸ“¦ Download Go dependencies
        run: go mod download

      # 11. æ„å»ºå¤šæ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶
      - name: ğŸ—ï¸ Build binaries
        run: |
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p build
          
          # å®šä¹‰æ„å»ºç›®æ ‡
          targets=(
            "linux/amd64"
            "linux/arm64"
            "windows/amd64"
            "darwin/amd64"
            "darwin/arm64"
          )
          
          # æ„å»ºæ¯ä¸ªç›®æ ‡
          for target in "${targets[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$target"
            
            echo "ğŸ”¨ Building for $GOOS/$GOARCH..."
            
            # è®¾ç½®è¾“å‡ºæ–‡ä»¶å
            output_name="hook-panel"
            if [ "$GOOS" = "windows" ]; then
              output_name="hook-panel.exe"
            fi
            
            # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
            CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags="-s -w -X main.version=${{ github.ref_name }}" \
              -o "build/${output_name}" \
              main.go
            
            # åˆ›å»ºå‹ç¼©åŒ…
            cd build
            if [ "$GOOS" = "windows" ]; then
              # Windows ä½¿ç”¨ zip æ ¼å¼
              zip -9 "hook-panel-${{ github.ref_name }}-${GOOS}-${GOARCH}.zip" "$output_name"
              echo "âœ… Created hook-panel-${{ github.ref_name }}-${GOOS}-${GOARCH}.zip"
            else
              # å…¶ä»–ç³»ç»Ÿä½¿ç”¨ tar.gz æ ¼å¼
              tar -czf "hook-panel-${{ github.ref_name }}-${GOOS}-${GOARCH}.tar.gz" "$output_name"
              echo "âœ… Created hook-panel-${{ github.ref_name }}-${GOOS}-${GOARCH}.tar.gz"
            fi
            
            # æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¿ç•™å‹ç¼©åŒ…
            rm "$output_name"
            cd ..
          done
          
          echo "ğŸ‰ All builds completed!"
          ls -la build/

      # 12. ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
      - name: ğŸ” Generate checksums
        run: |
          cd build
          sha256sum * > checksums.txt
          echo "ğŸ“‹ Generated checksums:"
          cat checksums.txt

      # 13. åˆ›å»º Release è¯´æ˜
      - name: ğŸ“ Generate release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ Hook Panel ${{ github.ref_name }}
          
          ### ğŸ“¦ æ”¯æŒçš„æ¶æ„
          
          - **Linux AMD64** (x86_64) - é€‚ç”¨äºå¤§å¤šæ•° Linux æœåŠ¡å™¨
          - **Linux ARM64** - é€‚ç”¨äº ARM64 æ¶æ„çš„ Linux æœåŠ¡å™¨
          - **Windows AMD64** - é€‚ç”¨äº Windows ç³»ç»Ÿ
          - **macOS Intel** - é€‚ç”¨äº Intel èŠ¯ç‰‡çš„ macOS
          - **macOS Apple Silicon** - é€‚ç”¨äº M1/M2 èŠ¯ç‰‡çš„ macOS
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„å‹ç¼©åŒ…
          2. è§£å‹ç¼©æ–‡ä»¶
          3. è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼š
             ```bash
             # Linux/macOS
             ./hook-panel
             
             # Windows
             hook-panel.exe
             ```
          
          ### âœ¨ ç‰¹æ€§
          
          - ğŸ¯ è½»é‡çº§ Webhook è„šæœ¬ç®¡ç†å¹³å°
          - ğŸ” å®‰å…¨çš„å¯†é’¥è®¤è¯æœºåˆ¶
          - ğŸ“Š å®æ—¶ä»ªè¡¨æ¿å’Œç»Ÿè®¡ä¿¡æ¯
          - ğŸ“ è„šæœ¬æ‰§è¡Œæ—¥å¿—è®°å½•
          - ğŸŒ ç°ä»£åŒ–çš„ Web ç•Œé¢
          - ğŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
          
          ### ğŸ” æ ¡éªŒå’Œ
          
          è¯·ä½¿ç”¨ `checksums.txt` æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
          EOF

      # 14. åˆ›å»º GitHub Release
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Hook Panel ${{ github.ref_name }}"
          body_path: release_notes.md
          files: |
            build/*.tar.gz
            build/*.zip
            build/checksums.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 15. æ¸…ç†æ„å»ºäº§ç‰©
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf build/
          rm -f release_notes.md
          echo "âœ… Cleanup completed"
