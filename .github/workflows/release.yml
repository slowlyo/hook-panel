name: ğŸš€ Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

env:
  GO_VERSION: '1.23'
  NODE_VERSION: '22'

jobs:
  build-and-release:
    name: ğŸ—ï¸ Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Go ç¯å¢ƒ
      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 4. è®¾ç½® pnpm
      - name: ğŸ“¦ Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      # 5. ç¼“å­˜ Go æ¨¡å—
      - name: ğŸ’¾ Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # 6. ç¼“å­˜ Node.js ä¾èµ–
      - name: ğŸ’¾ Cache Node.js dependencies
        uses: actions/cache@v4
        with:
          path: |
            web/node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('web/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 7. å®‰è£…å‰ç«¯ä¾èµ–
      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./web
        run: pnpm install --frozen-lockfile

      # 8. æ„å»ºå‰ç«¯é¡¹ç›®
      - name: ğŸ—ï¸ Build frontend
        working-directory: ./web
        run: pnpm build

      # 9. éªŒè¯å‰ç«¯æ„å»ºäº§ç‰©
      - name: âœ… Verify frontend build
        run: |
          if [ ! -d "web/dist" ]; then
            echo "âŒ Frontend build failed: web/dist directory not found"
            exit 1
          fi
          if [ ! -f "web/dist/index.html" ]; then
            echo "âŒ Frontend build failed: index.html not found"
            exit 1
          fi
          echo "âœ… Frontend build successful"
          ls -la web/dist/

      # 10. ä¸‹è½½ Go ä¾èµ–
      - name: ğŸ“¦ Download Go dependencies
        run: go mod download

      # 11. æ„å»ºå¤šæ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶
      - name: ğŸ—ï¸ Build binaries
        run: |
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p build
          
          # å®šä¹‰æ„å»ºç›®æ ‡
          targets=(
            "linux/amd64"
            "linux/arm64"
            "windows/amd64"
            "darwin/amd64"
            "darwin/arm64"
          )
          
          # æ„å»ºæ¯ä¸ªç›®æ ‡
          for target in "${targets[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$target"
            
            echo "ğŸ”¨ Building for $GOOS/$GOARCH..."
            
            # è®¾ç½®è¾“å‡ºæ–‡ä»¶å
            output_name="hook-panel"
            if [ "$GOOS" = "windows" ]; then
              output_name="hook-panel.exe"
            fi
            
            # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
            CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags="-s -w -X main.version=${{ github.ref_name }}" \
              -o "build/${output_name}" \
              main.go
            
            # åˆ›å»ºå‹ç¼©åŒ…
            cd build
            if [ "$GOOS" = "windows" ]; then
              # Windows ä½¿ç”¨ zip æ ¼å¼
              archive_name="hook-panel-${GOOS}-${GOARCH}.zip"
              zip -9 "$archive_name" "$output_name"
              echo "âœ… Created $archive_name"
            else
              # å…¶ä»–ç³»ç»Ÿä½¿ç”¨ tar.gz æ ¼å¼
              archive_name="hook-panel-${GOOS}-${GOARCH}.tar.gz"
              tar -czf "$archive_name" "$output_name"
              echo "âœ… Created $archive_name"
            fi

            # æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¿ç•™å‹ç¼©åŒ…
            rm "$output_name"
            cd ..
          done
          
          echo "ğŸ‰ All builds completed!"
          ls -la build/

      # 12. ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
      - name: ğŸ” Generate checksums
        run: |
          cd build
          sha256sum * > checksums.txt
          echo "ğŸ“‹ Generated checksums:"
          cat checksums.txt

      # 13. åˆ›å»º Release è¯´æ˜
      - name: ğŸ“ Generate release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Downloads

          | Platform | Architecture | Download |
          |----------|-------------|----------|
          | Linux | AMD64 | [hook-panel-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hook-panel-linux-amd64.tar.gz) |
          | Linux | ARM64 | [hook-panel-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hook-panel-linux-arm64.tar.gz) |
          | Windows | AMD64 | [hook-panel-windows-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hook-panel-windows-amd64.zip) |
          | macOS | Intel | [hook-panel-darwin-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hook-panel-darwin-amd64.tar.gz) |
          | macOS | Apple Silicon | [hook-panel-darwin-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hook-panel-darwin-arm64.tar.gz) |

          ## Verification

          Use [checksums.txt](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/checksums.txt) to verify file integrity.

          For detailed usage instructions, please refer to the [README](https://github.com/${{ github.repository }}/blob/main/README.md).
          EOF

      # 14. åˆ›å»º GitHub Release
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Hook Panel ${{ github.ref_name }}"
          body_path: release_notes.md
          files: |
            build/*.tar.gz
            build/*.zip
            build/checksums.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 15. æ¸…ç†æ„å»ºäº§ç‰©
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf build/
          rm -f release_notes.md
          echo "âœ… Cleanup completed"
